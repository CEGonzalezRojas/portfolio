class KonaCode{constructor(a){if(KonaCode.n_n)throw new Error("Only one instance of KC allowed");if(this.register(a.codes),!this.codes.length)throw new Error("You have to define at least 1 valid code");KonaCode.n_n=this,this.currentSequence=[],this.delayedDelta=500,this.domParser=new DOMParser,KonaCode.appendStyles(),(!a.event||a.event&&-1==KonaCode.keyboardEvent.indexOf(a.event))&&(a.event="keyup"),this.keyboardEvent="keyup",this.joystickEnable=void 0===a.joystickEnable||a.joystickEnable,this.feedbackEnable=void 0!==a.feedback&&a.feedback,this.feedbackEnable&&this.prepareFeedback(),this.touchXStart=this.touchXEnd=this.touchYStart=this.touchYEnd=null,this.touchMinMovement=15,this.activeJoystick=null,this.events()}register(a){if(!a)throw new Error("You have to define at least 1 code");Array.isArray(a)||(a=[a]);const b=KonaCode.basicSetup();this.codes||(this.codes=[]);for(const d of a){if(d.sequence){if(!Array.isArray(d.sequence)||3>d.sequence.length)continue;if(d.sequence=d.sequence.map(a=>a.toUpperCase?a.toUpperCase():a),-1==[KonaCode.keys.UP,KonaCode.keys.DOWN,KonaCode.keys.LEFT,KonaCode.keys.RIGHT].indexOf(d.sequence[0]))continue;const a=Object.values(KonaCode.keys);if(d.sequence.join()!=d.sequence.filter(b=>-1!=a.indexOf(b)).join())continue}else d.sequence=b.sequence;d.skin&&("string"!=typeof d.skin||-1==Object.values(KonaCode.skins).indexOf(d.skin))&&(d.skin=b.skin),d.color&&("string"!=typeof d.color||-1==Object.values(KonaCode.colors).indexOf(d.color))&&delete d.color,this.codes.find(a=>a.sequence.join()==d.sequence.join())&&this.codes.splice(this.codes.findIndex(a=>a.sequence.join()==d.sequence.join()),1),this.codes.push(d)}}events(){KonaCode.isMobile()?"ontouchstart"in window?(window.addEventListener("touchstart",a=>{this.touchStart(a)}),window.addEventListener("touchend",a=>{this.touchEnd(a)}),window.addEventListener("touchcancel",a=>{this.touchCancel(a)})):(window.addEventListener("mousedown",a=>{this.touchStart(a)}),window.addEventListener("mouseup",a=>{this.touchEnd(a)})):window.addEventListener(this.keyboardEvent,a=>{this.handler(a)})}handler(a){if(this.cleanExecTimeout(),!KonaCode.n_n||!a.code&&!a.keyCode)return;const b=this.transcript(a.code||a.keyCode),c=this.currentSequence.length;this.validCodes||(this.validCodes=this.codes);const d=this.validCodes.filter(a=>a.sequence[c]!=b);if(this.validCodes=this.validCodes.filter(a=>a.sequence[c]==b),this.validCodes.length){this.currentSequence.push(b),this.appendToFeedback(b);for(const a of this.validCodes)a.progress&&"function"==typeof a.progress&&a.progress(this.currentSequence.length,Math.floor(100*(this.currentSequence.length/a.sequence.length)));for(const a of d)a.progress&&"function"==typeof a.progress&&a.progress(0,0);const a=this.validCodes.filter(a=>a.sequence.length==this.currentSequence.length);if(a.length)this.exec(a[0],1!=this.validCodes.length);else{const a=this.validCodes.filter(a=>KonaCode.needJoystick(this.transcript(a.sequence[this.currentSequence.length])));a.length?this.showJoystick(a[0]):this.hideJoystick()}}else this.hideFromFeedback(),this.resetCurrentSequence()}exec(a,b){a&&a.callback?b?this.execTimeout=setTimeout(()=>{this.exec(a)},this.delayedDelta):("function"==typeof a.callback&&a.callback(),this.hideFromFeedback(),this.resetCurrentSequence()):this.resetCurrentSequence()}cleanExecTimeout(){clearTimeout(this.execTimeout)}resetCurrentSequence(){for(const a of this.codes)a.progress&&"function"==typeof a.progress&&a.progress(0,0);this.hideJoystick(),this.currentSequence.length=0,delete this.validCodes}transcript(a){switch(a){case"ArrowUp":case 38:case KonaCode.keys.UP:return KonaCode.keys.UP;break;case"ArrowDown":case 40:case KonaCode.keys.DOWN:return KonaCode.keys.DOWN;break;case"ArrowLeft":case 37:case KonaCode.keys.LEFT:return KonaCode.keys.LEFT;break;case"ArrowRight":case 39:case KonaCode.keys.RIGHT:return KonaCode.keys.RIGHT;break;case"KeyA":case 65:case KonaCode.keys.A:return KonaCode.keys.A;break;case"KeyB":case 66:case KonaCode.keys.B:return KonaCode.keys.B;break;case"KeyX":case 88:case KonaCode.keys.X:return KonaCode.keys.X;break;case"KeyY":case 89:case KonaCode.keys.Y:return KonaCode.keys.Y;break;default:return-1;}}touchStart(a){"ontouchstart"in window?(this.touchXStart=a.touches[0].clientX,this.touchYStart=a.touches[0].clientY):(this.touchXStart=a.clientX,this.touchYStart=a.clientY)}touchEnd(){this.touchXStart=null,this.touchYStart=null}touchEnd(a){null===this.touchXStart||null===this.touchYStart||("ontouchend"in window?(this.touchXEnd=a.changedTouches[0].clientX,this.touchYEnd=a.changedTouches[0].clientY):(this.touchXEnd=a.clientX,this.touchYEnd=a.clientY),Math.abs(this.touchYEnd-this.touchYStart)>=Math.abs(this.touchXEnd-this.touchXStart)?this.touchYEnd+this.touchMinMovement<this.touchYStart?this.handler({code:"ArrowUp"}):this.touchYEnd-this.touchMinMovement>this.touchYStart&&this.handler({code:"ArrowDown"}):this.touchXEnd+this.touchMinMovement<this.touchXStart?this.handler({code:"ArrowLeft"}):this.touchXEnd-this.touchMinMovement>this.touchXStart&&this.handler({code:"ArrowRight"}))}showJoystick(a){if(!this.joystickEnable)return;if(this.activeJoystick){this.currentSequence.length&&this.activeJoystick.classList.add("show");const b=a&&a.color?a.color:null;if(b){const a=this.activeJoystick.dataset.skin.split("-")[0];this.activeJoystick.dataset.skin=`${a}-${b}`}return}const b=a&&a.skin?a.skin:KonaCode.skins.SNES,c=a&&a.color?a.color:null;this.activeJoystick=this.domParser.parseFromString(KonaCode.htmlTemplates[b],"text/html").body.firstChild,c&&(this.activeJoystick.dataset.skin=`${b}-${c}`),setTimeout(()=>{this.activeJoystick.classList.add("show")},100),this.activeJoystick.addEventListener("transitionend",()=>{this.activeJoystick.classList.contains("show")||(this.activeJoystick.remove(),this.activeJoystick=null)});for(const c of["a","b","x","y"]){const a=this.activeJoystick.querySelector(`[${c}]`);a&&(a.addEventListener("animationend",c=>{`${b}-joystick-clicked`==c.animationName&&a.removeAttribute("clicked")}),a.addEventListener("click",()=>{a.setAttribute("clicked",!0),this.handler({code:`Key${c.toUpperCase()}`})}))}document.body.append(this.activeJoystick)}hideJoystick(){this.activeJoystick&&this.activeJoystick.classList.remove("show")}prepareFeedback(){this.feedbackElement||(this.feedbackElement=this.domParser.parseFromString("<div class=\"konafeed\"></div>","text/html").body.firstChild),document.body.append(this.feedbackElement)}appendToFeedback(a){if(!this.feedbackEnable)return;let b="";a===KonaCode.keys.UP?b="\u25B2":a===KonaCode.keys.DOWN?b="\u25BC":a===KonaCode.keys.LEFT?b="\u25C0\uFE0E":a===KonaCode.keys.RIGHT?b="\u25B6\uFE0E":a===KonaCode.keys.A?b="A":a===KonaCode.keys.B?b="B":a===KonaCode.keys.X?b="X":a===KonaCode.keys.Y?b="Y":void 0;const c=this.domParser.parseFromString(`<div data-key="${b}"></div>`,"text/html").body.firstChild;c.addEventListener("animationend",a=>{"konafeed-key-disappear"==a.animationName&&c.remove()}),this.feedbackElement.append(c)}hideFromFeedback(){if(this.feedbackEnable){const a=Array.from(this.feedbackElement.children);for(const[b,d]of a.entries())d.classList.add("hide")}}static basicSetup(){return{sequence:[KonaCode.keys.UP,KonaCode.keys.UP,KonaCode.keys.DOWN,KonaCode.keys.DOWN,KonaCode.keys.LEFT,KonaCode.keys.RIGHT,KonaCode.keys.LEFT,KonaCode.keys.RIGHT,KonaCode.keys.B,KonaCode.keys.A],skin:KonaCode.skins.SNES}}static needJoystick(a){return-1!=[KonaCode.keys.A,KonaCode.keys.B,KonaCode.keys.X,KonaCode.keys.Y].indexOf(`${a}`)}static isMobile(){const a=navigator.userAgent;return!![/Android/i,/iPhone/i,/iPod/i,/iPad/i,/Windows Phone/i,/webOS/i,/SymbianOS/i,/RIM/i,/BB/i].find(b=>a.match(b))}static appendStyles(){const a=document.createElement("LINK");a.href=`${this.source}kc.css`,a.type="text/css",a.rel="stylesheet",document.querySelector("head").append(a),this.htmlTemplates={};for(const a of Object.values(this.skins)){const b=document.createElement("LINK");b.href=`${this.source}skins/${a}/style.css`,b.type="text/css",b.rel="stylesheet",document.querySelector("head").append(b),fetch(`${this.source}skins/${a}/config.json`).then(a=>a.json()).then(b=>{this.htmlTemplates[a]=b.html?b.html:"<div></div>"}).catch(()=>{this.htmlTemplates[a]="<div></div>"})}}}KonaCode.keys={UP:"UP",DOWN:"DOWN",LEFT:"LEFT",RIGHT:"RIGHT",B:"B",A:"A",X:"X",Y:"Y"},KonaCode.skins={SNES:"snes",SWITCH:"switch"},KonaCode.colors={RED:"red",BLUE:"blue",YELLOW:"yellow",GREEN:"green",PINK:"pink",PURPLE:"purple",GRAY:"gray",RAINBOW:"rainbow"},KonaCode.keyboardEvent=["keyup","keydown"],KonaCode.source=`${document.currentScript.src.split("/").slice(0,-1).join("/")}/`;